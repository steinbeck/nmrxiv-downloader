---
phase: 02-search
plan: 01
type: execute
---

<objective>
Implement search functionality for molecules and dataset filtering by experiment type.

Purpose: Enable Claude Code to find NMR datasets by compound name, SMILES, or experiment type.
Output: Working `nmrxiv search` command with molecule and dataset search capabilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-search/02-RESEARCH.md

**API Capabilities (from RESEARCH.md):**
- POST /v1/search/{smiles?} - Search molecules by SMILES or name
- GET /v1/list/datasets?page=N - Paginated dataset listing (5970 total)
- Dataset `type` field contains experiment type (hsqc, 1d-13C, etc.)
- No server-side dataset filtering - must filter client-side

**Experiment types to support:**
- 1d: 1d-13C, 1d-1H
- 2d: hsqc, hmbc, hmqc, cosy, noesy, tocsy, dept
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add molecular search to API client</name>
  <files>nmrxiv_downloader/client.py, nmrxiv_downloader/models.py</files>
  <action>
Extend client with molecular search:

1. Add Molecule model to models.py:
   - molecular_formula, molecular_weight
   - canonical_smiles, inchi, inchi_key
   - synonyms (str), iupac_name
   - id, identifier

2. Add to NmrXivClient:
   - search_molecules(query: str = None, smiles: str = None) -> list[Molecule]
   - POST to /v1/search/{smiles} with body {"query": query}
   - Handle pagination (return first page for now, add pagination param later)

3. Handle both search modes:
   - If smiles provided: substructure search
   - If query provided: name/synonym search
   - Can combine both
  </action>
  <verify>python -c "from nmrxiv_downloader.client import NmrXivClient; c = NmrXivClient(); m = c.search_molecules(query='kaempferol'); print(f'Found {len(m)} molecules')"</verify>
  <done>Client can search molecules by name and SMILES</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination support to client</name>
  <files>nmrxiv_downloader/client.py, nmrxiv_downloader/models.py</files>
  <action>
Add pagination support:

1. Add PaginatedResponse model to models.py:
   - items: list
   - total: int
   - page: int
   - per_page: int
   - last_page: int

2. Update list_datasets in client:
   - Add page parameter (default 1)
   - Return PaginatedResponse with metadata
   - Extract from response meta: total, current_page, per_page, last_page

3. Update list_projects similarly

4. Keep backward compatibility - existing code should still work
  </action>
  <verify>python -c "from nmrxiv_downloader.client import NmrXivClient; c = NmrXivClient(); r = c.list_datasets(page=1); print(f'Page {r.page} of {r.last_page}, total: {r.total}')"</verify>
  <done>Client supports pagination for dataset and project listings</done>
</task>

<task type="auto">
  <name>Task 3: Add dataset filtering by experiment type</name>
  <files>nmrxiv_downloader/client.py</files>
  <action>
Add client-side filtering:

1. Add filter_datasets method to NmrXivClient:
   - filter_datasets(experiment_type: str = None, page: int = 1) -> PaginatedResponse
   - Fetch page of datasets
   - Filter by type field (case-insensitive, partial match)
   - E.g., "hsqc" matches "hsqc - 1H-13C"

2. Implement experiment type normalization:
   - Map common names to patterns: "hsqc", "hmbc", "cosy", "1d-13c", etc.
   - Handle variations in API data (spaces, dashes, case)

3. Note: Client-side filtering means total/pagination may be inaccurate
   - Document this limitation
   - Full filtering would require fetching all pages
  </action>
  <verify>python -c "from nmrxiv_downloader.client import NmrXivClient; c = NmrXivClient(); r = c.filter_datasets('hsqc'); print(f'Found {len(r.items)} hsqc datasets on page 1')"</verify>
  <done>Client can filter datasets by experiment type</done>
</task>

<task type="auto">
  <name>Task 4: Update CLI search command</name>
  <files>nmrxiv_downloader/cli.py</files>
  <action>
Implement the search command:

1. Update search command with options:
   - --query, -q: Search molecules by name
   - --smiles, -s: Search molecules by SMILES
   - --type, -t: Filter datasets by experiment type
   - --page, -p: Page number (default 1)

2. Search modes:
   - If --query or --smiles: Search molecules via /v1/search
   - If --type: Filter datasets by experiment type
   - Can combine molecule search with type filter (future)

3. Output format:
   {
     "results": [...],
     "count": N,
     "search_type": "molecule|dataset",
     "query": {...},
     "page": 1,
     "total": N
   }

4. Add helpful error messages for invalid inputs
  </action>
  <verify>nmrxiv search --query kaempferol | python -c "import sys,json; d=json.load(sys.stdin); print(f'Found {d[\"count\"]} results')"</verify>
  <done>CLI search command works with molecules and experiment types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nmrxiv search --query kaempferol` returns molecule results
- [ ] `nmrxiv search --smiles CCO` returns molecules with ethanol substructure
- [ ] `nmrxiv search --type hsqc` returns HSQC datasets
- [ ] `nmrxiv search --type "1d-13c"` returns 1D 13C datasets
- [ ] Pagination works: `nmrxiv search --type hsqc --page 2`
- [ ] All output is valid JSON
- [ ] Errors are structured JSON
</verification>

<success_criteria>

- All tasks completed
- Molecule search by name works
- Molecule search by SMILES works
- Dataset filtering by experiment type works
- Pagination supported
- JSON output parseable by Claude Code
</success_criteria>

<output>
After completion, create `.planning/phases/02-search/02-01-SUMMARY.md`

Then update:
- .planning/STATE.md
- .planning/ROADMAP.md
</output>
