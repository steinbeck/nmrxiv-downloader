---
phase: 04-download
plan: 01
type: execute
---

<objective>
Implement dataset download with progress indication and organized directory structure.

Purpose: Enable Claude Code to download NMR datasets to local disk for analysis.
Output: Working `nmrxiv download` command that downloads project archives with progress.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Download capabilities:**
- Projects have `download_url` field pointing to ZIP archives on S3
- Datasets are part of project archives (no individual download)
- ZIP files contain NMR data (Bruker folders, JCAMP-DX files, etc.)

**Example download URL:**
https://s3.uni-jena.de/nmrxiv/production/archive/{uuid}/{slug}.zip
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download method to API client</name>
  <files>nmrxiv_downloader/client.py</files>
  <action>
Add download functionality to NmrXivClient:

1. Add get_download_url(item_id: str) -> str | None method:
   - Fetch item by ID
   - Return download_url if available
   - Return None for items without download URL

2. Add download_file(url: str, dest: Path, progress_callback=None) method:
   - Use httpx streaming to download large files
   - Call progress_callback(downloaded, total) during download
   - Return Path to downloaded file
  </action>
  <verify>python -c "from nmrxiv_downloader.client import NmrXivClient; c = NmrXivClient(); url = c.get_download_url('P5'); print(f'URL: {url[:50]}...')"</verify>
  <done>Client can get download URLs and download files</done>
</task>

<task type="auto">
  <name>Task 2: Implement download command with progress</name>
  <files>nmrxiv_downloader/cli.py</files>
  <action>
Implement the download command:

1. Arguments:
   - item_id: Required project/dataset ID
   - --output, -o: Output directory (default: current dir)
   - --extract, -x: Extract ZIP after download (flag)
   - --json/--no-json: Output format

2. Workflow:
   - Fetch item to get download_url
   - If no download_url, check if it's a dataset and suggest parent project
   - Download with Rich progress bar (when --no-json)
   - Optionally extract ZIP to output directory
   - Return JSON with download status and file path

3. JSON output format:
   {
     "status": "success",
     "id": "P5",
     "file": "/path/to/downloaded.zip",
     "size": 12345678,
     "extracted_to": "/path/to/extracted/" (if --extract)
   }

4. Progress display (--no-json):
   - Use rich.progress with download bar
   - Show filename, size, speed
  </action>
  <verify>nmrxiv download P5 --output /tmp --no-json</verify>
  <done>Download command works with progress and extraction</done>
</task>

<task type="auto">
  <name>Task 3: Add extraction and organization</name>
  <files>nmrxiv_downloader/cli.py</files>
  <action>
Add ZIP extraction with organization:

1. Extract ZIP to output directory:
   - Create subdirectory with project identifier (e.g., P5/)
   - Extract ZIP contents into subdirectory
   - Handle existing directories (skip or overwrite option)

2. Output after extraction:
   - List extracted files/directories
   - Report total extracted size

3. JSON output includes:
   - extracted_to: Path to extraction directory
   - files: List of extracted items (top-level only)
  </action>
  <verify>nmrxiv download P5 --output /tmp --extract | python -c "import sys,json; d=json.load(sys.stdin); print(f'Extracted to: {d.get(\"extracted_to\", \"N/A\")}')"</verify>
  <done>Extraction works and reports results</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nmrxiv download P5 --output /tmp` downloads ZIP file
- [ ] `nmrxiv download P5 --output /tmp --no-json` shows progress bar
- [ ] `nmrxiv download P5 --output /tmp --extract` extracts ZIP
- [ ] JSON output includes status, file path, and size
- [ ] Error handling for invalid IDs and missing download URLs
- [ ] Download works for projects with download_url
</verification>

<success_criteria>

- All tasks completed
- Download with progress bar works
- ZIP extraction works
- JSON output for Claude Code integration
- Proper error handling
</success_criteria>

<output>
After completion, create `.planning/phases/04-download/04-01-SUMMARY.md`

Then update:
- .planning/STATE.md (mark project complete!)
- .planning/ROADMAP.md
</output>
